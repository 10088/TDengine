system sh/stop_dnodes.sh

system sh/deploy.sh -n dnode1 -i 1
system sh/deploy.sh -n dnode2 -i 2
system sh/deploy.sh -n dnode3 -i 3
system sh/deploy.sh -n dnode4 -i 4

system sh/cfg.sh -n dnode1 -c balanceInterval -v 10
system sh/cfg.sh -n dnode2 -c balanceInterval -v 10
system sh/cfg.sh -n dnode3 -c balanceInterval -v 10
system sh/cfg.sh -n dnode4 -c balanceInterval -v 10

system sh/cfg.sh -n dnode1 -c mnodeEqualVnodeNum -v 4
system sh/cfg.sh -n dnode2 -c mnodeEqualVnodeNum -v 4
system sh/cfg.sh -n dnode3 -c mnodeEqualVnodeNum -v 4
system sh/cfg.sh -n dnode4 -c mnodeEqualVnodeNum -v 4

system sh/cfg.sh -n dnode1 -c wallevel -v 2
system sh/cfg.sh -n dnode2 -c wallevel -v 2
system sh/cfg.sh -n dnode3 -c wallevel -v 2
system sh/cfg.sh -n dnode4 -c wallevel -v 2

print ========== step1
system sh/exec.sh -n dnode1 -s start
sql connect
sleep 2000

print ========== step2
sql create dnode $hostname2
system sh/exec.sh -n dnode2 -s start
sql create dnode $hostname3
system sh/exec.sh -n dnode3 -s start

$x = 0
show2: 
	$x = $x + 1
	sleep 2000
	if $x == 10 then 
		return -1
	endi
	
sql show dnodes
print dnode1 openVnodes $data2_1
print dnode2 openVnodes $data2_2
print dnode3 openVnodes $data2_3
if $data2_1 != 0 then
  goto show2
endi
if $data2_2 != 0 then
  goto show2
endi
if $data2_3 != 0 then
  goto show2
endi

print ========== step3
sql create database d1 days 1 replica 2
sql create table d1.t1 (t timestamp, i int)
sql insert into d1.t1 values(1591160480000, 25)
sql insert into d1.t1 values(1591160480002, 24)
sql insert into d1.t1 values(1591160480003, 23)
sql insert into d1.t1 values(1591160480004, 22)
sql insert into d1.t1 values(1591160480005, 21)

sql insert into d1.t1 values(1591260480000, 35)
sql insert into d1.t1 values(1591260480002, 34)
sql insert into d1.t1 values(1591260480003, 33)
sql insert into d1.t1 values(1591260480004, 32)
sql insert into d1.t1 values(1591260480005, 31)

sql insert into d1.t1 values(1591360480000, 45)
sql insert into d1.t1 values(1591360480002, 44)
sql insert into d1.t1 values(1591360480003, 43)
sql insert into d1.t1 values(1591360480004, 42)
sql insert into d1.t1 values(1591360480005, 41)

sql insert into d1.t1 values(1591460480000, 55)
sql insert into d1.t1 values(1591460480002, 54)
sql insert into d1.t1 values(1591460480003, 53)
sql insert into d1.t1 values(1591460480004, 52)
sql insert into d1.t1 values(1591460480005, 51)

sql insert into d1.t1 values(1591560480000, 65)
sql insert into d1.t1 values(1591560480002, 64)
sql insert into d1.t1 values(1591560480003, 63)
sql insert into d1.t1 values(1591560480004, 62)
sql insert into d1.t1 values(1591560480005, 61)

sql insert into d1.t1 values(1591660480000, 75)
sql insert into d1.t1 values(1591660480002, 74)
sql insert into d1.t1 values(1591660480003, 73)
sql insert into d1.t1 values(1591660480004, 72)
sql insert into d1.t1 values(1591660480005, 71)

$x = 0
show3: 
	$x = $x + 1
	sleep 2000
	if $x == 10 then 
		return -1
	endi

sql show dnodes
print dnode1 openVnodes $data2_1
print dnode2 openVnodes $data2_2
print dnode3 openVnodes $data2_3
if $data2_1 != 0 then
  goto show3
endi
if $data2_2 != 1 then
  goto show3
endi
if $data2_3 != 1 then
  goto show3
endi

sleep 3000

print ========== step4
system sh/exec.sh -n dnode2 -s stop  -x SIGINT
system sh/exec.sh -n dnode3 -s stop  -x SIGINT

print ========== step5
system_content rm -rf ../../../sim/dnode3/data/vnode/vnode2/tsdb/data/v2f18418.*

print ========== step6
system sh/exec.sh -n dnode2 -s start
system sh/exec.sh -n dnode3 -s start

return

# print ========== step7
# system sh/exec.sh -n dnode1 -s stop  -x SIGINT
# system sh/exec.sh -n dnode2 -s stop  -x SIGINT
# system sh/exec.sh -n dnode3 -s stop  -x SIGINT